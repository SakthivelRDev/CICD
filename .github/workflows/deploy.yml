name: Build and Push to Docker Hub

# This workflow runs on any push to the 'main' branch
on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    # Use a matrix strategy to run the same steps for both frontend and backend
    strategy:
      matrix:
        service: [frontend, backend]

    steps:
      # Step 1: Check out your repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set the 7-character commit SHA as a tag
      - name: Set tag for the image
        id: meta
        run: echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # Step 3: Log in to Docker Hub using secrets
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 4: Build the Docker image and push it to Docker Hub
      - name: Build and push Docker image
        run: |
          # Define image name and build context path
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service }}
          BUILD_CONTEXT=./myapp/${{ matrix.service }}

          # Build the image with both 'latest' and SHA tags
          docker build -f ${BUILD_CONTEXT}/Dockerfile \
            -t ${IMAGE_NAME}:${{ steps.meta.outputs.tag }} \
            -t ${IMAGE_NAME}:latest ${BUILD_CONTEXT}
            
          # Push both tags to Docker Hub
          docker push ${IMAGE_NAME} --all-tags